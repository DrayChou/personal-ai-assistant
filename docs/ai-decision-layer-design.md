# AIå†³ç­–å±‚é‡æ„è®¾è®¡æ–¹æ¡ˆ

## 1. æ ¸å¿ƒç†å¿µï¼šåˆ†å±‚å†³ç­– + LLMæ™ºèƒ½å…œåº•

### 1.1 è®¾è®¡åŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **å¿«é€Ÿå“åº”** | ç®€å•æŒ‡ä»¤ç›´æ¥å¤„ç†ï¼Œä¸è°ƒç”¨LLM |
| **æ™ºèƒ½å…œåº•** | å¤æ‚åœºæ™¯äº¤ç»™LLMå†³ç­–ï¼Œè€Œéé¢„è®¾è§„åˆ™ |
| **æœ€å°å¹²é¢„** | ä¸è¿‡åº¦çº¦æŸLLMï¼Œè®©å…¶è‡ªä¸»ç†è§£ |
| **å®‰å…¨ç¡®è®¤** | é‡è¦æ“ä½œï¼ˆåˆ é™¤ï¼‰å¿…é¡»æœ‰ç¡®è®¤æµç¨‹ |
| **è‡ªç„¶å¯¹è¯** | æ”¯æŒå¤šè½®äº¤äº’ï¼Œä¿æŒä¸Šä¸‹æ–‡è¿è´¯ |

### 1.2 ä¸nanobotå’Œå½“å‰ç³»ç»Ÿçš„å¯¹æ¯”

```
nanobotæ–¹å¼:                    å½“å‰ç³»ç»Ÿæ–¹å¼:                æ–°è®¾è®¡æ–¹æ¡ˆ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç”¨æˆ·è¾“å…¥         â”‚            â”‚ ç”¨æˆ·è¾“å…¥         â”‚          â”‚ ç”¨æˆ·è¾“å…¥         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                              â”‚                            â”‚
         â–¼                              â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç›´æ¥äº¤ç»™LLM      â”‚            â”‚ IntentClassifierâ”‚          â”‚ å¿«é€Ÿæ„å›¾æ£€æµ‹    â”‚
â”‚ (æ— é¢„è®¾è§„åˆ™)     â”‚            â”‚ (è§„åˆ™åŒ¹é…)      â”‚          â”‚ (è½»é‡çº§è§„åˆ™)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                              â”‚                            â”‚
         â–¼                              â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LLMè‡ªä¸»é€‰å·¥å…·    â”‚            â”‚ ActionRouter    â”‚          â”‚ å†³ç­–åˆ†æµ        â”‚
â”‚                  â”‚            â”‚ (é¢„è®¾handler)   â”‚          â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                              â”‚                            â”‚
    å·¥å…·æ‰§è¡Œ                        å·¥å…·æ‰§è¡Œ                    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
                                                              â–¼         â–¼
                                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                    â”‚ å¿«é€Ÿè·¯å¾„     â”‚ â”‚ LLMæ™ºèƒ½å†³ç­–  â”‚
                                                    â”‚ (æ— éœ€LLM)   â”‚ â”‚ (Function   â”‚
                                                    â”‚             â”‚ â”‚  Calling)   â”‚
                                                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                                           â”‚               â”‚
                                                           â–¼               â–¼
                                                      ç›´æ¥æ‰§è¡Œ        å·¥å…·æ‰§è¡Œ
```

## 2. å†³ç­–æµç¨‹è®¾è®¡

### 2.1 ä¸‰å±‚å†³ç­–æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           AIå†³ç­–å±‚æ¶æ„                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Layer 1: å¿«é€Ÿæ„å›¾æ£€æµ‹ (Fast Intent Detection)                       â”‚   â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚
â”‚  â”‚ â€¢ è½»é‡çº§è§„åˆ™åŒ¹é…ï¼ŒO(1)å“åº”                                          â”‚   â”‚
â”‚  â”‚ â€¢ è¯†åˆ«ï¼šé—®å€™ã€æ„Ÿè°¢ã€ç®€å•æŒ‡ä»¤                                        â”‚   â”‚
â”‚  â”‚ â€¢ ä¸è°ƒç”¨LLMï¼Œç›´æ¥è¿”å›å“åº”                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                        â”‚
â”‚                    æœªåŒ¹é… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Layer 2: æ™ºèƒ½å†³ç­–å±‚ (Smart Decision Layer)                          â”‚   â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚
â”‚  â”‚ â€¢ æ„å»ºç²¾ç®€System Prompt                                             â”‚   â”‚
â”‚  â”‚ â€¢ Function Callingé€‰æ‹©å·¥å…·                                          â”‚   â”‚
â”‚  â”‚ â€¢ æ”¯æŒå·¥å…·æ‰§è¡Œ + è‡ªç„¶è¯­è¨€å›å¤                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                        â”‚
â”‚                    éœ€è¦ç¡®è®¤ â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                    å¤šè½®äº¤äº’ â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Layer 3: å¯¹è¯çŠ¶æ€ç®¡ç† (Dialogue State Management)                   â”‚   â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚
â”‚  â”‚ â€¢ ç¡®è®¤æµç¨‹å¤„ç†                                                      â”‚   â”‚
â”‚  â”‚ â€¢ ä¸Šä¸‹æ–‡ä¿æŒ                                                        â”‚   â”‚
â”‚  â”‚ â€¢ å¤šè½®å·¥å…·è°ƒç”¨                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å®Œæ•´å†³ç­–æµç¨‹å›¾

```
ç”¨æˆ·è¾“å…¥
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å¿«é€Ÿæ„å›¾æ£€æµ‹      â”‚
â”‚ - é—®å€™/æ„Ÿè°¢/å‘Šåˆ«     â”‚
â”‚ - ç®€å•æŒ‡ä»¤åŒ¹é…       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â–¼           â–¼
  åŒ¹é…        æœªåŒ¹é…
    â”‚           â”‚
    â–¼           â–¼
å¿«é€Ÿå“åº”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
(æ— LLM)     â”‚ 2. æ„å»ºLLMä¸Šä¸‹æ–‡     â”‚
            â”‚ - Identity          â”‚
            â”‚ - Skills (åŠ¨æ€åŠ è½½)  â”‚
            â”‚ - Memory (ç›¸å…³è®°å¿†)  â”‚
            â”‚ - Tools (å¯ç”¨å·¥å…·)   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ 3. LLM Function Call â”‚
            â”‚ - ç†è§£ç”¨æˆ·æ„å›¾       â”‚
            â”‚ - é€‰æ‹©å·¥å…·           â”‚
            â”‚ - æå–å‚æ•°           â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼                   â–¼
        é€‰æ‹©å·¥å…·              ç›´æ¥å›å¤
            â”‚                   â”‚
            â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 4. å·¥å…·æ‰§è¡Œ    â”‚    â”‚ è¿”å›è‡ªç„¶è¯­è¨€   â”‚
    â”‚ - æ‰§è¡Œå‰æ£€æŸ¥   â”‚    â”‚ å›å¤ç»™ç”¨æˆ·     â”‚
    â”‚ - æ‰§è¡Œæ“ä½œ     â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ - è¿”å›ç»“æœ     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
    â–¼               â–¼
éœ€è¦ç¡®è®¤?        æ— éœ€ç¡®è®¤
    â”‚               â”‚
    â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ä¿å­˜ç¡®è®¤çŠ¶æ€â”‚   â”‚æ ¼å¼åŒ–ç»“æœ     â”‚
â”‚ç­‰å¾…ç”¨æˆ·è¾“å…¥â”‚   â”‚è¿”å›ç»™ç”¨æˆ·     â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
ç”¨æˆ·è¾“å…¥"ç¡®è®¤"
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚æ‰§è¡Œç¡®è®¤çš„æ“ä½œ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 3. System Promptè®¾è®¡

### 3.1 ç²¾ç®€ç‰ˆSystem Promptç»“æ„

```markdown
# èº«ä»½å®šä¹‰ (Identity)
ä½ æ˜¯ç”¨æˆ·çš„ä¸ªäººAIåŠ©æ‰‹ï¼Œæ€§æ ¼å‹å¥½ã€é«˜æ•ˆã€å¯é ã€‚

---

# å½“å‰ä¸Šä¸‹æ–‡ (Context)
æ—¶é—´: 2026-02-25 10:00:00
ç”¨æˆ·: [ç”¨æˆ·èº«ä»½/åå¥½æ‘˜è¦]

---

# å¯ç”¨èƒ½åŠ› (Capabilities)
ä½ æœ‰ä»¥ä¸‹å·¥å…·å¯ä»¥ä½¿ç”¨ï¼š

## ä»»åŠ¡ç®¡ç†
- create_task: åˆ›å»ºä»»åŠ¡/æé†’
- list_tasks: æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨
- complete_task: å®Œæˆä»»åŠ¡
- delete_tasks: åˆ é™¤/æ¸…ç†ä»»åŠ¡

## è®°å¿†ç®¡ç†
- add_memory: è®°å½•ä¿¡æ¯åˆ°è®°å¿†
- search_memory: æœç´¢å†å²è®°å¿†

## å…¶ä»–
- web_search: æœç´¢ç½‘ç»œä¿¡æ¯
- chat: è¿›è¡Œè‡ªç„¶å¯¹è¯

---

# ç›¸å…³è®°å¿† (Relevant Memories)
[åŠ¨æ€æ£€ç´¢çš„è®°å¿†å†…å®¹ï¼Œé™åˆ¶3-5æ¡]

---

# æŒ‡ä»¤ (Instructions)
1. å‡†ç¡®ç†è§£ç”¨æˆ·æ„å›¾ï¼Œé€‰æ‹©åˆé€‚çš„å·¥å…·
2. å½“ç”¨æˆ·è¯´"æ¸…ç†"ã€"åˆ é™¤"æ—¶ï¼Œä½¿ç”¨ delete_tasks
3. å½“ç”¨æˆ·è¯´"æŸ¥çœ‹"ã€"æœ‰ä»€ä¹ˆ"æ—¶ï¼Œä½¿ç”¨ list_tasks
4. é‡è¦æ“ä½œï¼ˆåˆ é™¤ï¼‰ä¼šè‡ªåŠ¨è¦æ±‚ç”¨æˆ·ç¡®è®¤
```

### 3.2 ä¸å½“å‰System Promptå¯¹æ¯”

| ç»´åº¦ | å½“å‰System Prompt | æ–°System Prompt |
|------|------------------|-----------------|
| é•¿åº¦ | è¿‡é•¿ï¼ˆåŒ…å«è¯¦ç»†è§„åˆ™ã€ç¤ºä¾‹ï¼‰ | ç²¾ç®€ï¼ˆåªåˆ—èƒ½åŠ›è¾¹ç•Œï¼‰ |
| è§„åˆ™ | å¤§é‡é¢„è®¾è§„åˆ™çº¦æŸLLM | æœ€å°è§„åˆ™ï¼Œè®©LLMè‡ªä¸»å†³ç­– |
| ç¤ºä¾‹ | åŒ…å«Few-shotç¤ºä¾‹ | ç§»é™¤ç¤ºä¾‹ï¼Œå‡å°‘token |
| è®°å¿† | é™æ€æ³¨å…¥ | åŠ¨æ€æ£€ç´¢ç›¸å…³è®°å¿† |
| äººæ ¼ | å¤æ‚æ¨¡æ¿ | ç®€æ´æè¿° |

## 4. å·¥å…·é€‰æ‹©ç­–ç•¥

### 4.1 Function Calling vs è§„åˆ™åŒ¹é…

```python
# ç­–ç•¥å†³ç­–çŸ©é˜µ
TOOL_SELECTION_STRATEGY = {
    # åœºæ™¯: é€‰æ‹©æ–¹å¼
    "ç®€å•æŒ‡ä»¤(é—®å€™/æ„Ÿè°¢)": "è§„åˆ™åŒ¹é… - ç›´æ¥å“åº”",
    "æ˜ç¡®ä»»åŠ¡æ“ä½œ(åˆ›å»º/åˆ é™¤/å®Œæˆ)": "Function Calling - LLMé€‰æ‹©",
    "æ¨¡ç³ŠæŒ‡ä»¤(çœ‹çœ‹ä»»åŠ¡)": "Function Calling + ç¡®è®¤æœºåˆ¶",
    "å¤šæ­¥å¤æ‚ä»»åŠ¡": "Function Calling + ReActæ¨¡å¼",
    "ä¿¡æ¯æŸ¥è¯¢(å¤©æ°”/æœç´¢)": "Function Calling - LLMé€‰æ‹©",
}
```

### 4.2 å·¥å…·æè¿°ä¼˜åŒ–

å½“å‰å·¥å…·æè¿°çš„é—®é¢˜ï¼š
- è¿‡é•¿ï¼ŒåŒ…å«è¿‡å¤šè§„åˆ™å’Œç¤ºä¾‹
- è¯•å›¾ç”¨æè¿°çº¦æŸLLMè¡Œä¸º
- é‡å¤å¼ºè°ƒå…³é”®è¯

ä¼˜åŒ–åçš„å·¥å…·æè¿°åŸåˆ™ï¼š
- ç®€æ´æè¿°åŠŸèƒ½
- æ˜ç¡®ä½¿ç”¨åœºæ™¯
- ä¸é‡å¤è§„åˆ™ï¼ˆè§„åˆ™æ”¾åœ¨System Promptï¼‰

```python
# ä¼˜åŒ–å‰ (å½“å‰)
DELETE_TASKS_DESCRIPTION = """
ã€åˆ é™¤ä¸“ç”¨ã€‘ç”¨äºæ¸…ç†/åˆ é™¤/ç§»é™¤ä»»åŠ¡ã€‚è§¦å‘è¯ï¼š'æ¸…ç†'ã€'åˆ é™¤'ã€'ç§»é™¤'ã€'æ¸…ç©º'ã€'ä¸è¦äº†'ã€‚
é‡è¦ï¼šç”¨æˆ·è¯´'æŸ¥çœ‹'ã€'æ˜¾ç¤º'ã€'æœ‰ä»€ä¹ˆ'æ—¶ç»å¯¹ä¸è¦ç”¨æ­¤å·¥å…·ï¼Œåº”è¯¥ç”¨ list_tasksï¼
"""

# ä¼˜åŒ–å (æ–°è®¾è®¡)
DELETE_TASKS_DESCRIPTION = """
åˆ é™¤ä»»åŠ¡ã€‚å½“ç”¨æˆ·æƒ³è¦æ¸…ç†ã€åˆ é™¤æˆ–ç§»é™¤ä»»åŠ¡æ—¶ä½¿ç”¨ã€‚
é¦–æ¬¡è°ƒç”¨è¿”å›å¾…åˆ é™¤åˆ—è¡¨ï¼Œç”¨æˆ·ç¡®è®¤åæ‰§è¡Œåˆ é™¤ã€‚
"""
```

## 5. å¤šè½®å¯¹è¯å¤„ç†

### 5.1 å¯¹è¯çŠ¶æ€æœº

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   IDLE      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚         â”‚  (ç©ºé—²çŠ¶æ€)  â”‚         â”‚
         â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
         â”‚                â”‚                â”‚
         â”‚                â–¼                â”‚
         â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
         â”‚    â”Œâ”€â”€â”€â–ºâ”‚ PROCESSING  â”‚         â”‚
         â”‚    â”‚    â”‚ (å¤„ç†ä¸­)    â”‚         â”‚
         â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
         â”‚    â”‚           â”‚                â”‚
         â”‚    â”‚     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”          â”‚
         â”‚    â”‚     â–¼           â–¼          â”‚
         â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
         â”‚    â”‚ â”‚NEED_CONFIRMâ”‚  â”‚ COMPLETED â”‚   â”‚
         â”‚    â”‚ â”‚(éœ€è¦ç¡®è®¤)â”‚  â”‚ (å·²å®Œæˆ)  â”‚   â”‚
         â”‚    â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â”‚
         â”‚    â”‚      â”‚           â”‚         â”‚
         â”‚    â”‚      â–¼           â”‚         â”‚
         â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚         â”‚
         â”‚    â””â”€â”¤WAITING â”‚â—„â”€â”€â”€â”€â”€â”€â”˜         â”‚
         â”‚      â”‚(ç­‰å¾…è¾“å…¥)                 â”‚
         â”‚      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜                 â”‚
         â”‚           â”‚                     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ä¸Šä¸‹æ–‡ç®¡ç†

```python
class DialogueContext:
    """å¯¹è¯ä¸Šä¸‹æ–‡ç®¡ç†"""

    def __init__(self, session_id: str):
        self.session_id = session_id
        self.history: list[Message] = []  # å¯¹è¯å†å²
        self.pending_action: Action | None = None  # å¾…ç¡®è®¤æ“ä½œ
        self.extracted_entities: dict = {}  # å·²æå–çš„å®ä½“
        self.current_intent: Intent | None = None  # å½“å‰æ„å›¾

    def add_message(self, role: str, content: str):
        """æ·»åŠ æ¶ˆæ¯åˆ°å†å²"""
        self.history.append(Message(role=role, content=content))
        # ä¿ç•™æœ€è¿‘20æ¡
        if len(self.history) > 20:
            self.history = self.history[-20:]

    def set_pending_action(self, action: Action):
        """è®¾ç½®å¾…ç¡®è®¤æ“ä½œ"""
        self.pending_action = action

    def clear_pending_action(self):
        """æ¸…é™¤å¾…ç¡®è®¤æ“ä½œ"""
        self.pending_action = None
```

## 6. ç¡®è®¤æµç¨‹è®¾è®¡

### 6.1 ç¡®è®¤æœºåˆ¶

```python
class ConfirmationManager:
    """ç¡®è®¤æµç¨‹ç®¡ç†å™¨"""

    # éœ€è¦ç¡®è®¤çš„æ“ä½œç±»å‹
    REQUIRES_CONFIRMATION = {
        "delete_tasks": "åˆ é™¤ä»»åŠ¡",
        "clear_history": "æ¸…ç©ºå†å²",
        "export_data": "å¯¼å‡ºæ•°æ®",
    }

    def check_requires_confirmation(self, tool_name: str) -> bool:
        """æ£€æŸ¥æ“ä½œæ˜¯å¦éœ€è¦ç¡®è®¤"""
        return tool_name in self.REQUIRES_CONFIRMATION

    def create_confirmation_prompt(self, action: Action) -> str:
        """åˆ›å»ºç¡®è®¤æç¤º"""
        tool_name = action.tool_name
        action_desc = self.REQUIRES_CONFIRMATION.get(tool_name, "æ­¤æ“ä½œ")

        if tool_name == "delete_tasks":
            tasks = action.params.get("tasks", [])
            task_list = "\n".join([f"  â€¢ {t['title']}" for t in tasks[:5]])
            return f"ğŸ—‘ï¸ å‡†å¤‡{action_desc}:\n{task_list}\n\nâš ï¸ ç¡®è®¤è¦åˆ é™¤å—ï¼Ÿ(å›å¤'ç¡®è®¤'æˆ–'å–æ¶ˆ')"

        return f"âš ï¸ ç¡®è®¤è¦æ‰§è¡Œ{action_desc}å—ï¼Ÿ(å›å¤'ç¡®è®¤'æˆ–'å–æ¶ˆ')"

    def handle_user_response(self, response: str, pending_action: Action) -> ActionResult:
        """å¤„ç†ç”¨æˆ·ç¡®è®¤å“åº”"""
        response = response.lower().strip()

        confirm_keywords = ["ç¡®è®¤", "yes", "æ˜¯", "ç¡®å®š", "å¥½çš„", "æ‰§è¡Œ"]
        cancel_keywords = ["å–æ¶ˆ", "cancel", "no", "å¦", "ä¸", "ç®—äº†", "ä¸è¦"]

        if any(kw in response for kw in confirm_keywords):
            return ActionResult(
                action=pending_action,
                confirmed=True,
                response="æ­£åœ¨æ‰§è¡Œ..."
            )
        elif any(kw in response for kw in cancel_keywords):
            return ActionResult(
                action=None,
                confirmed=False,
                response="å·²å–æ¶ˆæ“ä½œ"
            )
        else:
            return ActionResult(
                action=pending_action,  # ä¿æŒå¾…ç¡®è®¤çŠ¶æ€
                confirmed=None,  # æœªå†³å®š
                response="è¯·å›å¤'ç¡®è®¤'æ‰§è¡Œï¼Œæˆ–'å–æ¶ˆ'æ”¾å¼ƒ"
            )
```

### 6.2 ç¡®è®¤æµç¨‹ç¤ºä¾‹

```
ç”¨æˆ·: å¸®æˆ‘æ¸…ç†ä»»åŠ¡
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LLMé€‰æ‹©å·¥å…·:        â”‚
â”‚ delete_tasks        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å·¥å…·æ‰§è¡Œ(æœªç¡®è®¤)    â”‚
â”‚ è¿”å›å¾…åˆ é™¤åˆ—è¡¨      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
åŠ©æ‰‹: ğŸ—‘ï¸ å‡†å¤‡åˆ é™¤ä»¥ä¸‹ä»»åŠ¡:
      â€¢ ä»»åŠ¡1
      â€¢ ä»»åŠ¡2

      ç¡®è®¤è¦åˆ é™¤å—ï¼Ÿ(å›å¤'ç¡®è®¤'æˆ–'å–æ¶ˆ')
          â”‚
          â–¼
ç”¨æˆ·: ç¡®è®¤
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æµ‹åˆ°å¾…ç¡®è®¤æ“ä½œ    â”‚
â”‚ æ‰§è¡Œåˆ é™¤            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
åŠ©æ‰‹: å·²åˆ é™¤2ä¸ªä»»åŠ¡
```

## 7. ä¼ªä»£ç å®ç°

### 7.1 æ ¸å¿ƒå†³ç­–å¼•æ“

```python
# src/ai_decision/engine.py

from enum import Enum, auto
from typing import Optional, AsyncGenerator
from dataclasses import dataclass

class DecisionLayer(Enum):
    FAST_PATH = auto()      # å¿«é€Ÿè·¯å¾„ï¼Œæ— LLM
    SMART_LAYER = auto()    # æ™ºèƒ½å†³ç­–å±‚ï¼ŒFunction Calling
    CONFIRMATION = auto()   # ç¡®è®¤æµç¨‹

@dataclass
class DecisionResult:
    layer: DecisionLayer
    response: str
    requires_confirmation: bool = False
    pending_action: Optional[Action] = None

class AIDecisionEngine:
    """
    AIå†³ç­–å¼•æ“

    èŒè´£ï¼š
    1. å¿«é€Ÿæ„å›¾æ£€æµ‹
    2. æ™ºèƒ½å†³ç­–ï¼ˆLLM Function Callingï¼‰
    3. ç¡®è®¤æµç¨‹ç®¡ç†
    4. ä¸Šä¸‹æ–‡ç»´æŠ¤
    """

    def __init__(
        self,
        llm_client: LLMClient,
        tool_registry: ToolRegistry,
        memory_system: MemorySystem,
        personality_manager: PersonalityManager
    ):
        self.llm = llm_client
        self.tools = tool_registry
        self.memory = memory_system
        self.personality = personality_manager
        self.context_builder = ContextBuilder()
        self.confirmation_manager = ConfirmationManager()

    async def process(
        self,
        user_input: str,
        session_context: DialogueContext
    ) -> AsyncGenerator[str, None]:
        """
        å¤„ç†ç”¨æˆ·è¾“å…¥çš„ä¸»å…¥å£

        Args:
            user_input: ç”¨æˆ·è¾“å…¥
            session_context: ä¼šè¯ä¸Šä¸‹æ–‡

        Yields:
            å“åº”ç‰‡æ®µï¼ˆæ”¯æŒæµå¼è¾“å‡ºï¼‰
        """
        # Step 1: æ£€æŸ¥æ˜¯å¦æœ‰å¾…ç¡®è®¤çš„æ“ä½œ
        if session_context.pending_action:
            result = self.confirmation_manager.handle_user_response(
                user_input,
                session_context.pending_action
            )

            if result.confirmed is True:
                # æ‰§è¡Œç¡®è®¤çš„æ“ä½œ
                async for chunk in self._execute_confirmed_action(result.action):
                    yield chunk
                session_context.clear_pending_action()
                return
            elif result.confirmed is False:
                # ç”¨æˆ·å–æ¶ˆ
                yield result.response
                session_context.clear_pending_action()
                return
            else:
                # æœªæ˜ç¡®ç¡®è®¤/å–æ¶ˆï¼Œç»§ç»­è¯¢é—®
                yield result.response
                return

        # Step 2: å¿«é€Ÿæ„å›¾æ£€æµ‹
        fast_result = self._fast_intent_detection(user_input)
        if fast_result:
            yield fast_result.response
            return

        # Step 3: æ™ºèƒ½å†³ç­–å±‚ï¼ˆFunction Callingï¼‰
        async for chunk in self._smart_decision(user_input, session_context):
            yield chunk

    def _fast_intent_detection(self, user_input: str) -> Optional[FastResult]:
        """
        å¿«é€Ÿæ„å›¾æ£€æµ‹

        åŒ¹é…ç®€å•æŒ‡ä»¤ï¼Œæ— éœ€è°ƒç”¨LLM
        """
        user_input_lower = user_input.lower().strip()

        # é—®å€™è¯­
        greetings = ["ä½ å¥½", "æ‚¨å¥½", "å—¨", "hello", "hi"]
        if any(g in user_input_lower for g in greetings) and len(user_input) < 10:
            return FastResult(response=self._get_greeting_response())

        # æ„Ÿè°¢
        thanks = ["è°¢è°¢", "æ„Ÿè°¢", "thank"]
        if any(t in user_input_lower for t in thanks):
            return FastResult(response="ä¸å®¢æ°”ï¼å¾ˆé«˜å…´èƒ½å¸®åˆ°ä½ ã€‚")

        # å‘Šåˆ«
        goodbyes = ["å†è§", "æ‹œæ‹œ", "bye", "goodbye"]
        if any(g in user_input_lower for g in goodbyes):
            return FastResult(response="å†è§ï¼æœ‰éœ€è¦éšæ—¶æ‰¾æˆ‘ã€‚")

        return None

    async def _smart_decision(
        self,
        user_input: str,
        session_context: DialogueContext
    ) -> AsyncGenerator[str, None]:
        """
        æ™ºèƒ½å†³ç­–å±‚

        ä½¿ç”¨Function Callingè®©LLMé€‰æ‹©å·¥å…·
        """
        # æ„å»ºä¸Šä¸‹æ–‡
        messages = self.context_builder.build(
            user_input=user_input,
            history=session_context.history,
            memory=self.memory,
            personality=self.personality
        )

        # Function Calling
        response = await self.llm.generate_with_tools(
            messages=messages,
            tools=self.tools.get_schemas()
        )

        if response.tool_calls:
            # LLMé€‰æ‹©äº†å·¥å…·
            tool_call = response.tool_calls[0]

            # æ£€æŸ¥æ˜¯å¦éœ€è¦ç¡®è®¤
            if self.confirmation_manager.check_requires_confirmation(tool_call.name):
                # å…ˆæ‰§è¡Œå·¥å…·è·å–å¾…æ“ä½œåˆ—è¡¨ï¼ˆä¸çœŸæ­£æ‰§è¡Œï¼‰
                preview_result = await self.tools.execute(
                    tool_call.name,
                    **tool_call.arguments,
                    preview=True  # é¢„è§ˆæ¨¡å¼
                )

                # åˆ›å»ºç¡®è®¤æç¤º
                action = Action(
                    tool_name=tool_call.name,
                    params=tool_call.arguments
                )
                confirmation_prompt = self.confirmation_manager.create_confirmation_prompt(
                    action,
                    preview_result
                )

                # ä¿å­˜å¾…ç¡®è®¤æ“ä½œ
                session_context.set_pending_action(action)

                yield confirmation_prompt
                return

            # ä¸éœ€è¦ç¡®è®¤ï¼Œç›´æ¥æ‰§è¡Œ
            result = await self.tools.execute(
                tool_call.name,
                **tool_call.arguments
            )

            # æ ¼å¼åŒ–ç»“æœ
            if result.success:
                yield result.observation
            else:
                yield f"æ“ä½œå¤±è´¥: {result.observation}"
        else:
            # LLMç›´æ¥å›å¤
            yield response.content

        # æ›´æ–°å¯¹è¯å†å²
        session_context.add_message("user", user_input)
        session_context.add_message("assistant", response.content)

    async def _execute_confirmed_action(self, action: Action) -> AsyncGenerator[str, None]:
        """æ‰§è¡Œå·²ç¡®è®¤çš„æ“ä½œ"""
        result = await self.tools.execute(
            action.tool_name,
            **action.params,
            confirmed=True
        )

        if result.success:
            yield result.observation
        else:
            yield f"æ“ä½œå¤±è´¥: {result.observation}"
```

### 7.2 ä¸Šä¸‹æ–‡æ„å»ºå™¨

```python
# src/ai_decision/context_builder.py

class ContextBuilder:
    """
    ä¸Šä¸‹æ–‡æ„å»ºå™¨

    æ„å»ºå‘é€ç»™LLMçš„å®Œæ•´ä¸Šä¸‹æ–‡
    """

    def build(
        self,
        user_input: str,
        history: list[Message],
        memory: MemorySystem,
        personality: PersonalityManager
    ) -> list[dict]:
        """æ„å»ºå®Œæ•´ä¸Šä¸‹æ–‡"""
        messages = []

        # 1. System Prompt
        system_prompt = self._build_system_prompt(personality, memory, user_input)
        messages.append({"role": "system", "content": system_prompt})

        # 2. å¯¹è¯å†å²ï¼ˆæœ€è¿‘10æ¡ï¼‰
        recent_history = history[-10:]
        for msg in recent_history:
            messages.append({"role": msg.role, "content": msg.content})

        # 3. å½“å‰ç”¨æˆ·è¾“å…¥
        messages.append({"role": "user", "content": user_input})

        return messages

    def _build_system_prompt(
        self,
        personality: PersonalityManager,
        memory: MemorySystem,
        user_input: str
    ) -> str:
        """æ„å»ºSystem Prompt"""
        parts = []

        # 1. èº«ä»½å®šä¹‰
        current_personality = personality.get_current()
        parts.append(f"# èº«ä»½\n{current_personality.system_prompt}")

        # 2. å½“å‰ä¸Šä¸‹æ–‡
        from datetime import datetime
        current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        parts.append(f"\n# å½“å‰æ—¶é—´\n{current_time}")

        # 3. å¯ç”¨èƒ½åŠ›ï¼ˆç®€åŒ–ç‰ˆï¼‰
        parts.append("""
# å¯ç”¨å·¥å…·
- create_task: åˆ›å»ºä»»åŠ¡/æé†’
- list_tasks: æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨
- complete_task: å®Œæˆä»»åŠ¡
- delete_tasks: åˆ é™¤ä»»åŠ¡ï¼ˆéœ€è¦ç¡®è®¤ï¼‰
- add_memory: è®°å½•ä¿¡æ¯
- search_memory: æœç´¢è®°å¿†
- web_search: ç½‘ç»œæœç´¢
- chat: è‡ªç„¶å¯¹è¯
""")

        # 4. ç›¸å…³è®°å¿†ï¼ˆåŠ¨æ€æ£€ç´¢ï¼‰
        relevant_memories = memory.recall(user_input, top_k=3)
        if relevant_memories:
            parts.append(f"\n# ç›¸å…³è®°å¿†\n{relevant_memories}")

        # 5. ç®€æ´æŒ‡ä»¤
        parts.append("""
# æŒ‡ä»¤
1. æ ¹æ®ç”¨æˆ·æ„å›¾é€‰æ‹©åˆé€‚å·¥å…·
2. "æ¸…ç†"ã€"åˆ é™¤" â†’ delete_tasks
3. "æŸ¥çœ‹"ã€"æœ‰ä»€ä¹ˆ" â†’ list_tasks
""")

        return "\n".join(parts)
```

### 7.3 å·¥å…·æ³¨å†Œä¸æ‰§è¡Œ

```python
# src/ai_decision/tools.py

from abc import ABC, abstractmethod
from dataclasses import dataclass

@dataclass
class ToolResult:
    success: bool
    observation: str
    data: dict = None
    error: str = None

class BaseTool(ABC):
    """å·¥å…·åŸºç±»"""

    name: str = ""
    description: str = ""
    parameters: list[dict] = []

    @abstractmethod
    async def execute(self, **kwargs) -> ToolResult:
        """æ‰§è¡Œå·¥å…·"""
        pass

    def get_schema(self) -> dict:
        """è·å–Function Calling Schema"""
        return {
            "type": "function",
            "function": {
                "name": self.name,
                "description": self.description,
                "parameters": {
                    "type": "object",
                    "properties": {
                        p["name"]: {
                            "type": p["type"],
                            "description": p["description"]
                        }
                        for p in self.parameters
                    },
                    "required": [p["name"] for p in self.parameters if p.get("required")]
                }
            }
        }

class ToolRegistry:
    """å·¥å…·æ³¨å†Œè¡¨"""

    def __init__(self):
        self._tools: dict[str, BaseTool] = {}

    def register(self, tool: BaseTool):
        """æ³¨å†Œå·¥å…·"""
        self._tools[tool.name] = tool

    def get(self, name: str) -> Optional[BaseTool]:
        """è·å–å·¥å…·"""
        return self._tools.get(name)

    def get_schemas(self) -> list[dict]:
        """è·å–æ‰€æœ‰å·¥å…·çš„Schema"""
        return [tool.get_schema() for tool in self._tools.values()]

    async def execute(self, name: str, **kwargs) -> ToolResult:
        """æ‰§è¡Œå·¥å…·"""
        tool = self._tools.get(name)
        if not tool:
            return ToolResult(
                success=False,
                observation=f"å·¥å…· {name} ä¸å­˜åœ¨",
                error="Tool not found"
            )
        return await tool.execute(**kwargs)
```

## 8. è¿ç§»è·¯å¾„

### 8.1 ä»å½“å‰ç³»ç»Ÿè¿ç§»

```
Phase 1: ç²¾ç®€System Prompt
- ä¿ç•™ç°æœ‰æ¶æ„
- ç®€åŒ–System Prompt
- ç§»é™¤å†—ä½™è§„åˆ™

Phase 2: ä¼˜åŒ–å·¥å…·æè¿°
- ç®€åŒ–å·¥å…·description
- ç§»é™¤é‡å¤çš„å…³é”®è¯å¼ºè°ƒ
- æµ‹è¯•LLMå·¥å…·é€‰æ‹©å‡†ç¡®ç‡

Phase 3: å¼•å…¥å¿«é€Ÿæ„å›¾æ£€æµ‹
- æ·»åŠ FastIntentDetector
- ç®€å•æŒ‡ä»¤ä¸èµ°LLM
- é™ä½å»¶è¿Ÿå’Œæˆæœ¬

Phase 4: é‡æ„ç¡®è®¤æµç¨‹
- å°†ç¡®è®¤é€»è¾‘ç§»åˆ°å·¥å…·å±‚
- ç»Ÿä¸€ç¡®è®¤æœºåˆ¶
- æ”¯æŒå¤šè½®å¯¹è¯

Phase 5: åŠ¨æ€è®°å¿†åŠ è½½
- æ ¹æ®æŸ¥è¯¢åŠ¨æ€æ£€ç´¢è®°å¿†
- é™åˆ¶è®°å¿†æ•°é‡å’Œé•¿åº¦
- ä¼˜åŒ–tokenä½¿ç”¨
```

### 8.2 å…³é”®æ”¹åŠ¨ç‚¹

| ç»„ä»¶ | å½“å‰å®ç° | æ–°å®ç° | æ”¹åŠ¨è¯´æ˜ |
|------|---------|--------|---------|
| IntentClassifier | å¤æ‚è§„åˆ™åŒ¹é… | è½»é‡çº§å¿«é€Ÿæ£€æµ‹ | åªå¤„ç†ç®€å•æŒ‡ä»¤ |
| ActionRouter | é¢„è®¾handleræ˜ å°„ | ç§»é™¤ï¼Œç›´æ¥LLMå†³ç­– | å‡å°‘ä¸­é—´å±‚ |
| System Prompt | é•¿æ–‡æœ¬+è¯¦ç»†è§„åˆ™ | ç²¾ç®€+èƒ½åŠ›è¾¹ç•Œ | è®©LLMè‡ªä¸»å†³ç­– |
| å·¥å…·æè¿° | é•¿æè¿°+å…³é”®è¯å¼ºè°ƒ | ç®€æ´æè¿° | ä¸è¯•å›¾çº¦æŸLLM |
| ç¡®è®¤æµç¨‹ | åˆ†æ•£åœ¨å„handler | ç»Ÿä¸€ConfirmationManager | ä¸€è‡´çš„ä½“éªŒ |
| è®°å¿†æ³¨å…¥ | é™æ€åŠ è½½ | åŠ¨æ€æ£€ç´¢ç›¸å…³è®°å¿† | ç²¾å‡†+çœtoken |

## 9. è¯„ä¼°æŒ‡æ ‡

### 9.1 å‡†ç¡®æ€§æŒ‡æ ‡

```python
# éœ€è¦ç›‘æ§çš„æŒ‡æ ‡
METRICS = {
    # æ„å›¾ç†è§£å‡†ç¡®ç‡
    "intent_accuracy": {
        "description": "LLMæ­£ç¡®ç†è§£ç”¨æˆ·æ„å›¾çš„æ¯”ä¾‹",
        "target": "> 95%",
        "measurement": "äººå·¥æ ‡æ³¨æµ‹è¯•é›†"
    },

    # å·¥å…·é€‰æ‹©å‡†ç¡®ç‡
    "tool_selection_accuracy": {
        "description": "Function Callingé€‰æ‹©æ­£ç¡®å·¥å…·çš„æ¯”ä¾‹",
        "target": "> 98%",
        "measurement": "å¯¹æ¯”é¢„æœŸå·¥å…·é€‰æ‹©"
    },

    # è¯¯åˆ ç‡
    "false_deletion_rate": {
        "description": "ç”¨æˆ·è¯´'æŸ¥çœ‹'ä½†æ‰§è¡Œäº†åˆ é™¤çš„æ¯”ä¾‹",
        "target": "< 0.1%",
        "measurement": "ç”Ÿäº§ç¯å¢ƒç›‘æ§"
    },

    # ç¡®è®¤æµç¨‹è§¦å‘ç‡
    "confirmation_trigger_rate": {
        "description": "åˆ é™¤æ“ä½œæ­£ç¡®è§¦å‘ç¡®è®¤çš„æ¯”ä¾‹",
        "target": "> 99%",
        "measurement": "ç”Ÿäº§ç¯å¢ƒç›‘æ§"
    }
}
```

### 9.2 æ€§èƒ½æŒ‡æ ‡

```python
PERFORMANCE_METRICS = {
    # å¿«é€Ÿè·¯å¾„å“åº”æ—¶é—´
    "fast_path_latency": {
        "target": "< 50ms",
        "p99": "< 100ms"
    },

    # Function Callingå“åº”æ—¶é—´
    "smart_layer_latency": {
        "target": "< 500ms",
        "p99": "< 1000ms"
    },

    # Tokenä½¿ç”¨é‡
    "token_usage": {
        "system_prompt_tokens": "< 800",
        "avg_per_request": "< 1500"
    }
}
```

## 10. æ€»ç»“

### 10.1 æ ¸å¿ƒæ”¹è¿›

1. **åˆ†å±‚å†³ç­–**ï¼šç®€å•æŒ‡ä»¤å¿«é€Ÿå“åº”ï¼Œå¤æ‚æŒ‡ä»¤LLMå†³ç­–
2. **ç²¾ç®€Prompt**ï¼šç§»é™¤å†—ä½™è§„åˆ™ï¼Œè®©LLMè‡ªä¸»ç†è§£
3. **ç»Ÿä¸€ç¡®è®¤**ï¼šé‡è¦æ“ä½œç»Ÿä¸€ç¡®è®¤æµç¨‹ï¼Œä¿è¯å®‰å…¨
4. **åŠ¨æ€è®°å¿†**ï¼šæŒ‰éœ€åŠ è½½ç›¸å…³è®°å¿†ï¼ŒèŠ‚çœtoken
5. **è‡ªç„¶å¯¹è¯**ï¼šæ”¯æŒå¤šè½®äº¤äº’ï¼Œä¿æŒä¸Šä¸‹æ–‡

### 10.2 é¢„æœŸæ•ˆæœ

- **å“åº”é€Ÿåº¦**ï¼šç®€å•æŒ‡ä»¤ä»500msé™è‡³50ms
- **å‡†ç¡®æ€§**ï¼šå·¥å…·é€‰æ‹©å‡†ç¡®ç‡ä»90%æå‡è‡³98%+
- **ç”¨æˆ·ä½“éªŒ**ï¼šæ›´è‡ªç„¶çš„å¯¹è¯ä½“éªŒï¼Œå‡å°‘"æ­»æ¿"æ„Ÿ
- **æˆæœ¬æ§åˆ¶**ï¼šå‡å°‘ä¸å¿…è¦çš„LLMè°ƒç”¨å’Œtokenæ¶ˆè€—

### 10.3 é£é™©æ§åˆ¶

- **è¯¯åˆ é£é™©**ï¼šç»Ÿä¸€ç¡®è®¤æµç¨‹ï¼Œå¿…é¡»ç”¨æˆ·ç¡®è®¤æ‰æ‰§è¡Œåˆ é™¤
- **ç†è§£åå·®**ï¼šä¿ç•™Function Callingçš„ç¡®å®šæ€§ï¼ŒLLMé€‰æ‹©å·¥å…·è€Œéè‡ªç”±ç”Ÿæˆ
- **ä¸Šä¸‹æ–‡ä¸¢å¤±**ï¼šå®Œå–„çš„å¯¹è¯çŠ¶æ€ç®¡ç†ï¼Œæ”¯æŒå¤šè½®äº¤äº’
